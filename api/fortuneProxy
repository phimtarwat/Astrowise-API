// api/fortuneProxy.js
import { findUser, updateUsage } from "../lib/googleSheet.js";

export default async function handler(req, res) {
  if (req.method !== "POST") {
    return res.status(405).json({ error: "method_not_allowed" });
  }

  const { user_id, token, question } = req.body;

  // ЁЯФО р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ input
  if (!user_id || !token || !question) {
    return res.status(400).json({
      error: "missing_fields",
      message: "тЭМ р╕Хр╣Йр╕нр╕Зр╕кр╣Ир╕З user_id, token р╣Бр╕ер╕░ question р╕бр╕▓р╕Фр╣Йр╕зр╕в",
    });
  }

  // ЁЯФН р╕лр╕▓ user р╣Гр╕Щ Google Sheet
  const user = await findUser(user_id, token);
  if (!user) {
    return res.status(401).json({
      error: "invalid_token",
      message: "тЭМ р╣Др╕бр╣Ир╕Юр╕Ър╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й р╕Бр╕гр╕╕р╕Ур╕▓р╕Лр╕╖р╣Йр╕нр╣Бр╕Юр╣Зр╕Бр╣Ар╕Бр╕Ир╣Гр╕лр╕бр╣Ир╕Др╣Ир╕░",
    });
  }

  // тП│ р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╕▒р╕Щр╕лр╕бр╕Фр╕нр╕▓р╕вр╕╕
  const today = new Date().toISOString().slice(0, 10);
  if (user.expiry && today > user.expiry) {
    return res.status(401).json({
      error: "expired",
      message: "тЭМ р╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╕Вр╕нр╕Зр╕Др╕╕р╕Ур╕лр╕бр╕Фр╕нр╕▓р╕вр╕╕р╣Бр╕ер╣Йр╕з р╕Бр╕гр╕╕р╕Ур╕▓р╕Лр╕╖р╣Йр╕нр╣Бр╕Юр╣Зр╕Бр╣Ар╕Бр╕Ир╣Гр╕лр╕бр╣Ир╕Др╣Ир╕░",
    });
  }

  // ЁЯОЯя╕П р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ quota
  if (user.quota <= 0) {
    return res.status(401).json({
      error: "no_quota",
      message: "тЭМ р╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╕лр╕бр╕Фр╣Бр╕ер╣Йр╕з р╕Бр╕гр╕╕р╕Ур╕▓р╕Лр╕╖р╣Йр╕нр╣Бр╕Юр╣Зр╕Бр╣Ар╕Бр╕Ир╣Гр╕лр╕бр╣Ир╕Др╣Ир╕░",
    });
  }

  // тЬЕ р╕лр╕▒р╕Б quota р╣Бр╕ер╕░р╣Ар╕Юр╕┤р╣Ир╕б used_count
  const newQuota = user.quota - 1;
  const updated = await updateUsage(user_id, token, newQuota);

  if (!updated) {
    return res.status(500).json({
      error: "update_failed",
      message: "тЭМ р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╣Др╕Фр╣Й",
    });
  }

  // ЁЯФо р╕Ьр╕ер╕Бр╕▓р╕гр╕Чр╕│р╕Щр╕▓р╕в (Demo тАФ р╕Хр╕гр╕Зр╕Щр╕╡р╣Йр╕Др╕╕р╕Ур╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Ар╕Кр╕╖р╣Ир╕нр╕б core astrology engine р╣Др╕Фр╣Й)
  const fortune = `ЁЯФо р╕Др╕│р╕Чр╕│р╕Щр╕▓р╕вр╕кр╕│р╕лр╕гр╕▒р╕Ъ "${question}" (Demo result)`;

  // тЪая╕П р╣Ар╕Хр╕╖р╕нр╕Щр╕Цр╣Йр╕▓ quota р╣Гр╕Бр╕ер╣Йр╕лр╕бр╕Ф
  let warning = "";
  if (newQuota < 3) {
    warning = `тЪая╕П р╣Ар╕лр╕ер╕╖р╕нр╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╕нр╕╡р╕Бр╣Ар╕Юр╕╡р╕вр╕З ${newQuota} р╕Др╕гр╕▒р╣Йр╕З р╕нр╕вр╣Ир╕▓р╕ер╕╖р╕бр╕Хр╣Ир╕нр╕нр╕▓р╕вр╕╕р╕Бр╣Ир╕нр╕Щр╕лр╕бр╕Фр╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╕Щр╕░р╕Др╕░`;
  }

  // тЬЕ р╕кр╣Ир╕Зр╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╕Бр╕ер╕▒р╕Ъ
  return res.json({
    success: true,
    remaining: newQuota,
    used: user.used_count + 1,
    answer: fortune,
    warning,
  });
}
